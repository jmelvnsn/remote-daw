<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAW Collaboration Tool</title>
    <!-- PeerJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <!-- Application CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>DAW Collaboration Tool</h1>
        <p>Connect your DAW and collaborate in real-time with other musicians</p>
        
        <div class="status" id="connectionStatus">Status: Disconnected</div>
        
        <div class="audio-settings">
            <h3>Audio Settings</h3>
            <div class="settings-row">
                <label for="audioInputSelect">Audio Input Device:</label>
                <select id="audioInputSelect">
                    <option value="" selected>Select Input Device...</option>
                    <!-- Devices will be populated via JavaScript -->
                </select>
                <button id="refreshDevicesBtn" class="small-button">Refresh</button>
            </div>
            <div class="settings-row">
                <label for="sampleRateSelect">Sample Rate:</label>
                <select id="sampleRateSelect">
                    <option value="44100">44.1 kHz</option>
                    <option value="48000" selected>48 kHz</option>
                    <option value="96000">96 kHz</option>
                </select>
            </div>
            <div class="settings-row">
                <label for="bufferSizeSelect">Buffer Size:</label>
                <select id="bufferSizeSelect">
                    <option value="32">32 (Ultra Low Latency)</option>
                    <option value="64">64 (Very Low Latency)</option>
                    <option value="96">96 (Low Latency)</option>
                    <option value="256">256 (Balanced)</option>
                    <option value="512" selected>512</option>
                    <option value="1024">1024</option>
                    <option value="2048">2048 (Most Stable)</option>
                </select>
            </div>
            <div class="settings-row">
                <label for="bitDepthSelect">Bit Depth:</label>
                <select id="bitDepthSelect">
                    <option value="16">16-bit</option>
                    <option value="24" selected>24-bit</option>
                    <option value="32">32-bit float</option>
                </select>
            </div>
        </div>
        
        <div class="controls">
            <button id="startAudioBtn">1. Start Audio Input</button>
            <button id="changeDeviceBtn" disabled>Change Input Device</button>
            <button id="createSessionBtn" disabled>2. Create Session</button>
            <button id="joinSessionBtn" disabled>2. Join Session</button>
        </div>
        
        <div class="connection-info">
            <div>
                <label for="sessionIdInput">Session ID:</label>
                <input type="text" id="sessionIdInput" placeholder="Enter session ID to join..." disabled />
                <div id="myPeerId" class="status" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div class="sharing-container" style="display: none;">
            <h3>Share Your Session</h3>
            <div class="settings-row">
                <input type="text" id="shareUrlInput" readonly />
                <button id="copyLinkBtn" class="small-button">Copy Link</button>
            </div>
            <p class="sharing-instructions">
                Share this link with others to invite them to your session. They'll need to:
                <ol>
                    <li>Open the link in their browser</li>
                    <li>Select their audio input device</li>
                    <li>Click "Start Audio Input"</li>
                    <li>Click "Join Session"</li>
                </ol>
            </p>
        </div>
        
        <div class="meters">
            <div class="local-meter-container">
                <label>Local Audio Level:</label>
                <meter id="localMeter" min="0" max="100" value="0"></meter>
            </div>
            <!-- Remote meters will be added dynamically -->
        </div>
        
        <div class="peers-container">
            <h3>Connected Peers:</h3>
            <ul id="peerList" class="peer-list">
                <!-- Peers will appear here -->
            </ul>
        </div>
        
        <div class="logs">
            <div id="logContainer"></div>
        </div>
        
        <h2>Setup Instructions</h2>
        <ol>
            <li>Route your DAW's audio output to your system's input (using Loopback, Soundflower, etc.)</li>
            <li>Select your virtual audio device from the Audio Input dropdown</li>
            <li>Configure audio settings as needed for your project</li>
            <li>Click "Start Audio Input" to capture audio from your system</li>
            <li>Create a new session or join an existing one using a Session ID</li>
            <li>Once connected, you'll hear each other's audio streams</li>
        </ol>
    </div>

    <!-- Application JavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/latency-monitor.js"></script>
    <script src="js/peer-manager.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/main.js"></script>
    

    <!-- Updated Debug Panel HTML -->
    <div id="audio-debug-panel" style="display: none;">
        <h3>Audio Debug Panel</h3>
        <button id="force-update-btn" class="warning">Force Update Latency</button>
        <button id="force-audio-btn" class="primary">Force Enable Audio</button>
        <button id="restart-audio-btn">Restart Audio Processing</button>
        <button id="check-connections-btn">Check Connections</button>
        <button id="refresh-latency-btn" class="secondary">Refresh Latency Display</button>
        <button id="fix-latency-updates-btn">Fix Latency Updates</button>
        <div id="audio-debug-log"></div>
    </div>
    
    <!-- Visible Debug Button -->
<button id="visible-debug-btn">Open Debug Panel</button>

    <script>
        // Debug panel toggle with Alt+D
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 'd') {
                const panel = document.getElementById('audio-debug-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // Debug panel buttons
        document.getElementById('force-audio-btn').addEventListener('click', () => {
            if (window.audioManager) {
                const result = window.audioManager.forceEnableAudio();
                logDebug(`Force enable result: ${result}`);
            }
        });
        
        document.getElementById('restart-audio-btn').addEventListener('click', () => {
            if (window.audioManager) {
                // Restart meter updates
                if (window.audioManager.meterUpdateInterval) {
                    cancelAnimationFrame(window.audioManager.meterUpdateInterval);
                    window.audioManager.meterUpdateInterval = null;
                }
                window.audioManager.startMeterUpdates();
                logDebug('Audio meter updates restarted');
            }
        });
        
        document.getElementById('check-connections-btn').addEventListener('click', () => {
            if (window.peerManager) {
                const peers = window.peerManager.getConnectedPeers();
                logDebug(`Connected peers: ${peers.length}`);
                
                peers.forEach(peerId => {
                    logDebug(`Checking peer ${peerId}...`);
                    const call = window.peerManager.calls[peerId];
                    if (call && call.peerConnection) {
                        logDebug(`PeerConnection state: ${call.peerConnection.connectionState}`);
                        logDebug(`ICE state: ${call.peerConnection.iceConnectionState}`);
                    }
                    
                    if (window.audioManager && window.audioManager.remoteStreams[peerId]) {
                        const remoteInfo = window.audioManager.remoteStreams[peerId];
                        if (remoteInfo.stream) {
                            const tracks = remoteInfo.stream.getTracks();
                            logDebug(`Remote tracks: ${tracks.length}`);
                            tracks.forEach((track, i) => {
                                logDebug(`Track ${i}: ${track.kind}, enabled=${track.enabled}`);
                            });
                        }
                    }
                });
            }
        });
        
        document.getElementById('refresh-latency-btn').addEventListener('click', () => {
            if (window.latencyMonitor) {
                const result = window.latencyMonitor.refreshAll();
                logDebug(`Latency refresh result: ${result}`);
                
                // Force an immediate update for all peers
                if (window.peerManager) {
                    const peers = window.peerManager.getConnectedPeers();
                    logDebug(`Forcing update for ${peers.length} peers`);
                    
                    peers.forEach(peerId => {
                        const latencyEl = document.getElementById(`latency-${peerId}`);
                        if (latencyEl) {
                            latencyEl.textContent = 'Updating...';
                            window.latencyMonitor.updateLatencyStats(peerId);
                        } else {
                            logDebug(`Latency element for ${peerId} not found, recreating...`);
                            
                            // Try to recreate the element
                            const meterDiv = document.getElementById(`remoteMeterDiv-${peerId}`);
                            if (meterDiv) {
                                const label = meterDiv.querySelector('label');
                                if (label) {
                                    const span = document.createElement('span');
                                    span.id = `latency-${peerId}`;
                                    span.className = 'latency-info';
                                    span.textContent = 'Measuring latency...';
                                    label.appendChild(document.createTextNode(' '));
                                    label.appendChild(span);
                                    logDebug(`Created new latency span for ${peerId}`);
                                    
                                    // Force update after creation
                                    setTimeout(() => {
                                        window.latencyMonitor.updateLatencyStats(peerId);
                                    }, 100);
                                }
                            }
                        }
                    });
                }
                
                // Show debug info after a delay
                setTimeout(() => {
                    if (window.latencyMonitor) {
                        window.latencyMonitor.debugLatencyMonitor();
                    }
                }, 1000);
            }
        });
        
        function logDebug(message) {
            const log = document.getElementById('audio-debug-log');
            const entry = document.createElement('div');
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
    </script>
    <script>
        document.getElementById('force-update-btn').addEventListener('click', () => {
            if (window.latencyMonitor) {
                const result = window.latencyMonitor.forceUpdate();
                logDebug(`Force update result: ${result}`);
                
                // Also run the debug function
                setTimeout(() => {
                    if (window.latencyMonitor) {
                        window.latencyMonitor.debugLatencyMonitor();
                    }
                }, 1000);
                
                // Add a clear visual indicator that something happened
                const debugLog = document.getElementById('audio-debug-log');
                if (debugLog) {
                    const indicator = document.createElement('div');
                    indicator.style.color = '#ff7597';
                    indicator.style.fontWeight = 'bold';
                    indicator.textContent = '*** Latency values have been forced to update! ***';
                    debugLog.appendChild(indicator);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        });
    </script>
</body>
</html>